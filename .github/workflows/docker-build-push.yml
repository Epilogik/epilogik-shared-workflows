name: Docker Build and Push

on:
  workflow_call:
    inputs:
      image_name:
        description: 'Docker image name (without registry prefix)'
        required: true
        type: string
      dockerfile_path:
        description: 'Path to Dockerfile relative to context'
        required: false
        type: string
        default: './Dockerfile'
      build_context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64,linux/arm64'
      push:
        description: 'Whether to push the image to registry'
        required: false
        type: boolean
        default: true
      registry:
        description: 'Container registry hostname'
        required: false
        type: string
        default: 'ghcr.io'
      tag_suffix:
        description: 'Additional tag suffix (e.g., staging, latest)'
        required: false
        type: string
        default: 'latest'
      build_args:
        description: 'Build arguments (key=value, one per line)'
        required: false
        type: string
        default: ''
      target:
        description: 'Dockerfile target stage'
        required: false
        type: string
        default: ''
      cache_enabled:
        description: 'Enable build caching'
        required: false
        type: boolean
        default: true
      security_scan:
        description: 'Enable security scanning with Trivy'
        required: false
        type: boolean
        default: true
      provenance:
        description: 'Generate provenance attestation'
        required: false
        type: boolean
        default: true
      sbom:
        description: 'Generate SBOM attestation'
        required: false
        type: boolean
        default: true
    secrets:
      registry_token:
        description: 'Registry authentication token'
        required: true
    outputs:
      image_digest:
        description: 'Image digest'
        value: ${{ jobs.build-push.outputs.digest }}
      image_tags:
        description: 'Generated image tags'
        value: ${{ jobs.build-push.outputs.tags }}
      full_image_name:
        description: 'Full image name with registry and tag'
        value: ${{ jobs.build-push.outputs.full_name }}
      image_size:
        description: 'Image size in MB'
        value: ${{ jobs.build-push.outputs.image_size }}
      scan_results:
        description: 'Security scan results summary'
        value: ${{ jobs.build-push.outputs.scan_summary }}

permissions:
  contents: read
  packages: write
  security-events: write
  id-token: write # Required for provenance
  attestations: write

jobs:
  build-push:
    name: ðŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 60
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      tags: ${{ steps.meta.outputs.tags }}
      full_name: ${{ steps.meta.outputs.tags }}
      image_size: ${{ steps.inspect.outputs.size }}
      scan_summary: ${{ steps.scan.outputs.summary }}

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for GitVersion and proper context

      - name: âœ… Validate inputs
        uses: ./../../.github/actions/docker-build/validate
        with:
          dockerfile_path: ${{ inputs.dockerfile_path }}
          build_context: ${{ inputs.build_context }}
          platforms: ${{ inputs.platforms }}

      - name: ðŸ·ï¸ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ inputs.registry }}/${{ inputs.image_name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=sha,prefix={{branch}}-,format=short
            type=raw,value=${{ inputs.tag_suffix }},enable={{is_default_branch}}
            type=raw,value=latest,enable={{is_default_branch}}
          labels: |
            org.opencontainers.image.title=${{ inputs.image_name }}
            org.opencontainers.image.description=Epilogik containerized application
            org.opencontainers.image.vendor=Epilogik
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created={{date 'YYYY-MM-DDTHH:mm:ssZ'}}
          annotations: |
            org.opencontainers.image.title=${{ inputs.image_name }}
            org.opencontainers.image.description=Epilogik containerized application
            org.opencontainers.image.vendor=Epilogik

      - name: ðŸ”§ Setup Docker
        uses: ./../../.github/actions/docker-build/setup
        with:
          registry: ${{ inputs.registry }}
          push: ${{ inputs.push }}

      - name: ðŸ’¾ Configure build cache
        if: inputs.cache_enabled
        run: |
          echo "ðŸ—‚ï¸ Configuring build cache..."
          echo "Cache will be stored in GitHub Actions cache"
          echo "Cache scope: ${{ inputs.registry }}/${{ inputs.image_name }}"

      - name: ðŸ”¨ Parse build arguments
        uses: ./../../.github/actions/docker-build/parse-args
        with:
          build_args: ${{ inputs.build_args }}

      - name: ðŸ³ Build & Push
        id: build
        uses: ./../../.github/actions/docker-build/build-push
        with:
          context: ${{ inputs.build_context }}
          file: ${{ inputs.dockerfile_path }}
          platforms: ${{ inputs.platforms }}
          push: ${{ inputs.push }}
          tags: ${{ steps.meta.outputs.tags }}
          target: ${{ inputs.target }}
          build_args: ${{ inputs.build_args }}
          provenance: ${{ inputs.provenance }}
          sbom: ${{ inputs.sbom }}

      - name: ðŸ” Inspect image
        if: inputs.push
        id: inspect
        uses: ./../../.github/actions/docker-build/inspect
        with:
          image_tag: ${{ steps.meta.outputs.tags }}

      - name: ðŸ›¡ï¸ Security scan
        if: inputs.security_scan && inputs.push
        id: scan
        uses: ./../../.github/actions/docker-build/scan
        with:
          image_tag: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          enabled: ${{ inputs.security_scan }}

      - name: ðŸ“¤ Upload scan results to GitHub Security
        if: inputs.security_scan && inputs.push && steps.scan.outcome == 'success'
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'docker-image-scan'

      - name: Upload scan results
        if: inputs.security_scan && inputs.push
        uses: actions/upload-artifact@v4
        with:
          name: trivy-scan-results-${{ github.run_id }}
          path: |
            trivy-results.sarif
            image-info.json
          retention-days: 30
          if-no-files-found: warn

      - name: ðŸ“‹ Generate build summary
        if: always()
        run: |
          echo "## ðŸ³ Docker Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Build Information
          echo "### ðŸ“Š Build Information" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Registry | \`${{ inputs.registry }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Name | \`${{ inputs.image_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag Suffix | \`${{ inputs.tag_suffix }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Platforms | ${{ inputs.platforms }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Context | \`${{ inputs.build_context }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Dockerfile | \`${{ inputs.dockerfile_path }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Pushed | ${{ inputs.push }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.push }}" == "true" ]; then
            echo "| Image Digest | \`${{ steps.build.outputs.digest }}\` |" >> $GITHUB_STEP_SUMMARY
            echo "| Image Size | ${{ steps.inspect.outputs.size || 'Unknown' }} MB |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Generated Tags
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ·ï¸ Generated Tags" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          
          # Security Information
          if [ "${{ inputs.security_scan }}" == "true" ] && [ "${{ inputs.push }}" == "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ›¡ï¸ Security Scan" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Scan Status | ${{ steps.scan-summary.outputs.scan_status || 'Not completed' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| Vulnerabilities | ${{ steps.scan-summary.outputs.summary || 'N/A' }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Build Features
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš™ï¸ Build Features" >> $GITHUB_STEP_SUMMARY
          echo "| Feature | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Caching | ${{ inputs.cache_enabled && 'âœ… Enabled' || 'âŒ Disabled' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Scan | ${{ inputs.security_scan && 'âœ… Enabled' || 'âŒ Disabled' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Provenance | ${{ inputs.provenance && 'âœ… Enabled' || 'âŒ Disabled' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM | ${{ inputs.sbom && 'âœ… Enabled' || 'âŒ Disabled' }} |" >> $GITHUB_STEP_SUMMARY
          
          # Status Summary
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Docker build completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Docker build failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. Check Dockerfile syntax and build context" >> $GITHUB_STEP_SUMMARY
            echo "2. Verify all required build arguments are provided" >> $GITHUB_STEP_SUMMARY
            echo "3. Ensure target platform compatibility" >> $GITHUB_STEP_SUMMARY
            echo "4. Check registry authentication and permissions" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up temporary files..."
          rm -f build-args.txt image-info.json
          echo "âœ… Cleanup completed"